#!/bin/bash
# openclaw-ctl — CLI for OpenClaw service management and log viewing
# Works on both server VMs and admin VMs

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

PROXY_PORT=32125
GATEWAY_PORT=18789

is_qubes_vm() { [ -f /usr/share/qubes/marker-vm ]; }
is_server_vm() { ss -tln 2>/dev/null | grep -q ":${PROXY_PORT} "; }

svc_state() {
    local svc=$1
    for prefix in qubes-openclaw openclaw; do
        local state
        state=$(systemctl is-active "${prefix}-${svc}.service" 2>/dev/null) && {
            echo "$state"
            return
        }
        state=$(systemctl --user is-active "${prefix}-${svc}.service" 2>/dev/null) && {
            echo "$state"
            return
        }
    done
    echo "not-found"
}

qsvc_enabled() {
    [ -f "/var/run/qubes-service/$1" ] && echo "on" || echo "off"
}

cmd_status() {
    echo -e "${BOLD}OpenClaw Status${NC}"
    echo ""

    if is_server_vm; then
        echo -e "  ${CYAN}Role: SERVER${NC}"
        echo ""

        local health auth ver models gw
        health=$(curl -sf --connect-timeout 2 "http://127.0.0.1:${PROXY_PORT}/health" 2>/dev/null)
        if [ -n "$health" ]; then
            auth=$(echo "$health" | python3 -c "import sys,json; print(json.load(sys.stdin).get('authenticated','?'))" 2>/dev/null)
            ver=$(echo "$health" | python3 -c "import sys,json; print(json.load(sys.stdin).get('proxy_version','?'))" 2>/dev/null)
            echo -e "  Proxy:     ${GREEN}● healthy${NC}  auth=$auth  ver=$ver"
        else
            echo -e "  Proxy:     ${RED}● down${NC}"
        fi

        gw=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 2 "http://127.0.0.1:${GATEWAY_PORT}/" 2>/dev/null)
        if [ "$gw" = "200" ]; then
            echo -e "  Gateway:   ${GREEN}● running${NC}  :${GATEWAY_PORT}"
        else
            echo -e "  Gateway:   ${RED}● down${NC}  HTTP $gw"
        fi

        models=$(curl -sf --connect-timeout 2 "http://127.0.0.1:${PROXY_PORT}/v1/models" 2>/dev/null | \
            python3 -c "import sys,json; print(len(json.load(sys.stdin).get('data',[])))" 2>/dev/null || echo "?")
        echo -e "  Models:    ${CYAN}$models available${NC}"
    else
        echo -e "  ${CYAN}Role: CLIENT${NC}"
        echo ""

        local proxy_ok gw_ok
        proxy_ok=$(curl -sf --connect-timeout 2 "http://127.0.0.1:${PROXY_PORT}/health" > /dev/null 2>&1 && echo "yes" || echo "no")
        gw_ok=$(curl -sf --connect-timeout 2 -o /dev/null -w "%{http_code}" "http://127.0.0.1:${GATEWAY_PORT}/" 2>/dev/null)

        if [ "$proxy_ok" = "yes" ]; then
            echo -e "  Proxy:     ${GREEN}● tunnel OK${NC}"
        else
            echo -e "  Proxy:     ${RED}● unreachable${NC}"
        fi

        if [ "$gw_ok" = "200" ]; then
            echo -e "  Gateway:   ${GREEN}● tunnel OK${NC}"
        else
            echo -e "  Gateway:   ${RED}● unreachable${NC}"
        fi
    fi

    echo ""
    echo -e "  ${BOLD}Services:${NC}"
    for svc in proxy gateway watchdog tunnels; do
        local state qflag
        state=$(svc_state "$svc")
        qflag=$(qsvc_enabled "openclaw-$svc")
        case "$state" in
            active) echo -e "    openclaw-$svc: ${GREEN}$state${NC} (qubes-service: $qflag)" ;;
            inactive|dead) echo -e "    openclaw-$svc: ${YELLOW}$state${NC} (qubes-service: $qflag)" ;;
            not-found) [ "$qflag" = "on" ] && echo -e "    openclaw-$svc: ${RED}missing${NC} (qubes-service: $qflag)" ;;
            *) echo -e "    openclaw-$svc: $state (qubes-service: $qflag)" ;;
        esac
    done

    if is_qubes_vm; then
        local vmname vmip
        vmname=$(qubesdb-read /name 2>/dev/null || echo "?")
        vmip=$(ip -4 addr show eth0 2>/dev/null | grep -oP 'inet \K[\d.]+' || echo "?")
        echo ""
        echo -e "  ${BOLD}VM:${NC} $vmname ($vmip)"
    fi
}

cmd_logs() {
    local target="${1:-all}"
    case "$target" in
        proxy)
            echo -e "${BOLD}Proxy logs:${NC}"
            journalctl --identifier=openclaw-proxy --no-pager -n 50 2>/dev/null || \
            journalctl --user -u openclaw-cursor-proxy --no-pager -n 50 2>/dev/null || \
            echo "No proxy journal entries"
            ;;
        gateway)
            echo -e "${BOLD}Gateway logs:${NC}"
            if [ -f "/tmp/openclaw/openclaw-$(date +%Y-%m-%d).log" ]; then
                tail -50 "/tmp/openclaw/openclaw-$(date +%Y-%m-%d).log" 2>/dev/null | \
                python3 -c "
import sys,json
for l in sys.stdin:
    try:
        d=json.loads(l.strip())
        ts=d.get('_meta',{}).get('date','')[:19]
        lvl=d.get('_meta',{}).get('logLevelName','')
        msg=d.get('1','') or d.get('message','')
        print(f'{ts} [{lvl:5s}] {msg}')
    except:
        print(l.rstrip())
"
            else
                journalctl --identifier=openclaw-gateway --no-pager -n 50 2>/dev/null || \
                echo "No gateway logs"
            fi
            ;;
        watchdog)
            echo -e "${BOLD}Watchdog logs:${NC}"
            journalctl --identifier=openclaw-watchdog --no-pager -n 30 2>/dev/null
            [ -f /tmp/openclaw-watchdog.log ] && tail -20 /tmp/openclaw-watchdog.log
            ;;
        tunnels)
            echo -e "${BOLD}Tunnel logs:${NC}"
            journalctl --identifier=openclaw-tunnels --no-pager -n 30 2>/dev/null
            [ -f /tmp/openclaw-tunnels.log ] && tail -20 /tmp/openclaw-tunnels.log
            ;;
        all)
            cmd_logs proxy
            echo ""
            cmd_logs gateway
            echo ""
            cmd_logs watchdog
            ;;
        *)
            echo "Usage: openclaw-ctl logs [proxy|gateway|watchdog|tunnels|all]"
            ;;
    esac
}

cmd_follow() {
    local target="${1:-gateway}"
    case "$target" in
        proxy)
            journalctl --identifier=openclaw-proxy -f 2>/dev/null || \
            journalctl --user -u openclaw-cursor-proxy -f 2>/dev/null
            ;;
        gateway)
            if [ -f "/tmp/openclaw/openclaw-$(date +%Y-%m-%d).log" ]; then
                tail -f "/tmp/openclaw/openclaw-$(date +%Y-%m-%d).log" | \
                python3 -u -c "
import sys,json
for l in sys.stdin:
    try:
        d=json.loads(l.strip())
        ts=d.get('_meta',{}).get('date','')[:19]
        lvl=d.get('_meta',{}).get('logLevelName','')
        msg=d.get('1','') or d.get('message','')
        print(f'{ts} [{lvl:5s}] {msg}', flush=True)
    except:
        print(l.rstrip(), flush=True)
"
            else
                journalctl --identifier=openclaw-gateway -f 2>/dev/null
            fi
            ;;
        *)
            journalctl --identifier="openclaw-$target" -f 2>/dev/null
            ;;
    esac
}

cmd_health() {
    echo -e "${BOLD}OpenClaw Deep Health Check${NC}"
    echo ""

    local ok=0 fail=0

    # Proxy /health
    local proxy_health
    proxy_health=$(curl -sf --connect-timeout 3 --max-time 10 "http://127.0.0.1:${PROXY_PORT}/health" 2>/dev/null)
    if [ -n "$proxy_health" ]; then
        local status auth
        status=$(echo "$proxy_health" | python3 -c "import sys,json; print(json.load(sys.stdin).get('status','?'))" 2>/dev/null)
        auth=$(echo "$proxy_health" | python3 -c "import sys,json; print(json.load(sys.stdin).get('authenticated','?'))" 2>/dev/null)
        if [ "$status" = "healthy" ]; then
            echo -e "  ${GREEN}✓${NC} Proxy healthy (auth=$auth)"
            ok=$((ok+1))
        else
            echo -e "  ${RED}✗${NC} Proxy status: $status"
            fail=$((fail+1))
        fi
    else
        echo -e "  ${RED}✗${NC} Proxy unreachable"
        fail=$((fail+1))
    fi

    # Gateway HTTP
    local gw_code
    gw_code=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 3 "http://127.0.0.1:${GATEWAY_PORT}/" 2>/dev/null)
    if [ "$gw_code" = "200" ]; then
        echo -e "  ${GREEN}✓${NC} Gateway HTTP 200"
        ok=$((ok+1))
    else
        echo -e "  ${RED}✗${NC} Gateway HTTP $gw_code"
        fail=$((fail+1))
    fi

    # Models endpoint
    local model_count
    model_count=$(curl -sf --connect-timeout 3 "http://127.0.0.1:${PROXY_PORT}/v1/models" 2>/dev/null | \
        python3 -c "import sys,json; print(len(json.load(sys.stdin).get('data',[])))" 2>/dev/null || echo 0)
    if [ "$model_count" -gt 0 ] 2>/dev/null; then
        echo -e "  ${GREEN}✓${NC} Models: $model_count available"
        ok=$((ok+1))
    else
        echo -e "  ${YELLOW}!${NC} Models: none returned"
        fail=$((fail+1))
    fi

    # Systemd services
    for svc in proxy gateway watchdog tunnels; do
        local state
        state=$(svc_state "$svc")
        case "$state" in
            active) echo -e "  ${GREEN}✓${NC} openclaw-$svc: active"; ok=$((ok+1)) ;;
            not-found) ;; # skip missing
            *) echo -e "  ${RED}✗${NC} openclaw-$svc: $state"; fail=$((fail+1)) ;;
        esac
    done

    echo ""
    if [ "$fail" -eq 0 ]; then
        echo -e "  ${GREEN}${BOLD}All $ok checks passed${NC}"
    else
        echo -e "  ${RED}${BOLD}$fail check(s) failed${NC}, $ok passed"
        return 1
    fi
}

cmd_cron() {
    local sub="${1:-list}"
    case "$sub" in
        list)
            echo -e "${BOLD}Cron jobs:${NC}"
            openclaw cron list 2>/dev/null || echo "No cron jobs configured (or openclaw not in PATH)"
            ;;
        add)
            shift
            openclaw cron add "$@"
            ;;
        remove)
            shift
            openclaw cron remove "$@"
            ;;
        *)
            echo "Usage: openclaw-ctl cron [list|add|remove] [args...]"
            echo "  add --message \"text\" --cron \"0 9 * * *\" --tz UTC"
            echo "  remove <id>"
            ;;
    esac
}

cmd_webhook_test() {
    local token
    token=$(python3 -c "
import json, os
try:
    cfg = json.load(open(os.path.expanduser('~/.openclaw/openclaw.json')))
    print(cfg.get('hooks',{}).get('token',''))
except: pass
" 2>/dev/null)

    if [ -z "$token" ]; then
        echo -e "${RED}No webhook token found in ~/.openclaw/openclaw.json${NC}"
        echo "Set hooks.token in your config first."
        return 1
    fi

    echo -e "${BOLD}Testing webhook endpoint...${NC}"
    local resp code
    resp=$(curl -sf -w "\n%{http_code}" --connect-timeout 5 --max-time 10 \
        -X POST "http://127.0.0.1:${GATEWAY_PORT}/hooks/wake" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $token" \
        -d '{}' 2>/dev/null)
    code=$(echo "$resp" | tail -1)
    local body
    body=$(echo "$resp" | head -n -1)

    if [ "$code" = "200" ] || [ "$code" = "204" ]; then
        echo -e "  ${GREEN}✓${NC} Webhook responded HTTP $code"
        [ -n "$body" ] && echo "  $body"
    else
        echo -e "  ${RED}✗${NC} Webhook responded HTTP $code"
        [ -n "$body" ] && echo "  $body"
        return 1
    fi
}

cmd_help() {
    echo "openclaw-ctl — OpenClaw service manager for Qubes OS"
    echo ""
    echo "Usage: openclaw-ctl <command> [args]"
    echo ""
    echo "Commands:"
    echo "  status              Show service health, ports, models, VM info"
    echo "  health              Deep health check of all endpoints and services"
    echo "  logs [component]    Show recent logs (proxy|gateway|watchdog|tunnels|all)"
    echo "  follow [component]  Tail logs in real time (proxy|gateway)"
    echo "  restart [component] Restart a service"
    echo "  cron [sub]          Manage cron jobs (list|add|remove)"
    echo "  webhook-test        Test webhook endpoint connectivity"
    echo "  harden              Run security hardening checks"
    echo "  help                This message"
    echo ""
    echo "Qubes services (toggled from dom0):"
    echo "  qvm-service <vm> openclaw-proxy on     Start proxy at boot"
    echo "  qvm-service <vm> openclaw-gateway on   Start gateway at boot"
    echo "  qvm-service <vm> openclaw-watchdog on  Start health watchdog at boot"
    echo "  qvm-service <vm> openclaw-tunnels on   Start tunnels at boot (admin VM)"
}

cmd_restart() {
    local target="${1:-all}"
    for prefix in qubes-openclaw openclaw; do
        if systemctl is-active "${prefix}-${target}.service" > /dev/null 2>&1; then
            echo "Restarting ${prefix}-${target}..."
            sudo systemctl restart "${prefix}-${target}.service"
            return
        fi
        if systemctl --user is-active "${prefix}-${target}.service" > /dev/null 2>&1; then
            echo "Restarting ${prefix}-${target} (user)..."
            systemctl --user restart "${prefix}-${target}.service"
            return
        fi
    done
    echo "Service openclaw-$target not found"
}

cmd_harden() {
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    if [ -x "$script_dir/harden.sh" ]; then
        exec "$script_dir/harden.sh"
    elif [ -x /usr/share/openclaw-cursor/scripts/harden.sh ]; then
        exec /usr/share/openclaw-cursor/scripts/harden.sh
    else
        echo "harden.sh not found"
        exit 1
    fi
}

case "${1:-status}" in
    status)       cmd_status ;;
    health)       cmd_health ;;
    logs)         cmd_logs "${2:-all}" ;;
    follow)       cmd_follow "${2:-gateway}" ;;
    restart)      cmd_restart "${2:-all}" ;;
    cron)         shift; cmd_cron "$@" ;;
    webhook-test) cmd_webhook_test ;;
    harden)       cmd_harden ;;
    help|-h|--help) cmd_help ;;
    *)            echo "Unknown: $1"; cmd_help; exit 1 ;;
esac
